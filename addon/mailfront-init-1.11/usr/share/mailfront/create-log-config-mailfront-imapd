#!/bin/sh
#
# check if we are started as root
# only one of UID and USER must be set correctly
#
if test "$UID" != 0 -a "$USER" != root; then
    echo >&2 "You must be root to start $0."
    exit 1
fi

#
# check for /etc/sysconfig/mailfront
#
if test ! -f /etc/sysconfig/mailfront ; then
    echo >&2 "No /etc/sysconfig/mailfront found."
    exit 1
fi 
. /etc/sysconfig/mailfront

test "$MAILFRONT_CREATE_CONFIG" = yes || exit 0

# this file contains generic mail setup information
if test -s /etc/sysconfig/mail ; then
    . /etc/sysconfig/mail
    test "$MAIL_CREATE_CONFIG" = yes || exit 0
fi

#
# set qmail config dirs
#
IMAPDDIR="${1:-/etc/mailfront-imapd}"
IMAPDENV="$IMAPDDIR/env"

#
# define preamble of config files
#
PREAMBLE="#
#
# Automatically generated on `env LANG=C date`
#
# PLEASE DO NOT EDIT THIS FILE
#
# Instead edit /etc/sysconfig/mailfront and restart the server.
#
#"

umask 022

# multilog
size=$(echo $IMAP_LOGSIZE | sed -e 's/[^0-9]//g')
test -z "$size" -o "$size" -lt 4096 && \
    echo -n >"$IMAPDENV/LOGSIZE" || \
    cat >"$IMAPDENV/LOGSIZE" <<ETX
$size
# sets the maximum file size for subsequent dir actions. multilog will
# decide that current is big enough if current has size bytes. (multilog
# will also decide that current is big enough if it sees a newline within
# 2000 bytes of the maximum file size; it tries to finish log files at line
# boundaries.) size must be between 4096 and 16777215.
$PREAMBLE
ETX

num=$(echo $IMAP_LOGNUM | sed -e 's/[^0-9]//g')
test -z "$num" -o "$num" -lt 2 && \
    echo -n >"$IMAPDENV/LOGNUM" || \
    cat >"$IMAPDENV/LOGNUM" <<ETX
$num
# sets the number of log files for subsequent dir actions. After renaming
# current, if multilog sees num or more old log files, it removes the old
# log file with the smallest timestamp. num must be at least 2.
$PREAMBLE
ETX
