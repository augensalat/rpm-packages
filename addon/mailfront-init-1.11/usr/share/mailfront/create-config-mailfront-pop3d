#!/bin/sh
#
# check if we are started as root
# only one of UID and USER must be set correctly
#
if test "$UID" != 0 -a "$USER" != root; then
    echo >&2 "You must be root to start $0."
    exit 1
fi

#
# check for /etc/sysconfig/mailfront
#
if test ! -f /etc/sysconfig/mailfront ; then
    echo >&2 "No /etc/sysconfig/mailfront found."
    exit 1
fi 
. /etc/sysconfig/mailfront

test "$MAILFRONT_CREATE_CONFIG" = yes || exit 0

# this file contains generic mail setup information
if test -s /etc/sysconfig/mail ; then
    . /etc/sysconfig/mail
    test "$MAIL_CREATE_CONFIG" = yes || exit 0
fi

#
# set qmail config dirs
#
POP3DDIR="${1:-/etc/mailfront-pop3d}"
POP3DENV="$POP3DDIR/env"

#
# define preamble of config files
#
PREAMBLE="#
#
# Automatically generated on $(env LANG=C date)
#
# PLEASE DO NOT EDIT THIS FILE
#
# Instead edit /etc/sysconfig/mailfront and restart the server.
#
#"

umask 022

test -z "$POP3_ADDRESS" -o "$POP3_ADDRESS" = 0 && \
    echo -n >"$POP3DENV/ADDRESS" || \
    cat >"$POP3DENV/ADDRESS" <<ETX
$POP3_ADDRESS
#
# IP address the POP3 daemon should bind to on this host.
# Default is "0", which means to listen on all addresses of this host.
$PREAMBLE
ETX
    
test -z "$POP3_PORT" -o "$POP3_PORT" -eq 0 && \
    echo -n >"$POP3DENV/PORT" || \
    cat >"$POP3DENV/PORT" <<ETX
$POP3_PORT
#
# Port number or name (from /etc/services) for the pop3 daemon.
$PREAMBLE
ETX

if test -z "$POP3_LOCALNAME" ; then
    test -s /etc/HOSTNAME && \
	cp /etc/HOSTNAME "$POP3DENV/LOCALNAME" || \
	(hostname -f | grep '\.' || echo 0) >"$POP3DENV/LOCALNAME"
else
    echo $POP3_LOCALNAME >"$POP3DENV/LOCALNAME"
fi
cat >>"$POP3DENV/LOCALNAME" <<ETX
#
# Set local hostname to keep tcpserver from looking it up in DNS.
# A common choice for localname is 0. To avoid loops, you must use this
# option for servers on TCP port 53.
$PREAMBLE
ETX

# concurrencypop3d
concurrency=$(echo $POP3_CONCURRENCY | sed -e 's/[^0-9]//g')
test -z "$concurrency" -o "$concurrency" -eq 0 && \
    echo -n >"$POP3DENV/CONCURRENCY" || \
    cat >"$POP3DENV/CONCURRENCY" <<ETX
$concurrency
#
# Maximum number of simultaneous pop3 daemon processes.
$PREAMBLE
ETX

# Timeouts
timeout=$(echo $POP3_TIMEOUT | sed -e 's/[^0-9]//g')
test -z "$timeout" -o "$timeout" -eq 0 && \
    echo -n >"$POP3DENV/TIMEOUT" || \
    cat >"$POP3DENV/TIMEOUT" <<ETX
$timeout
#
# Times out connections after value seconds of inactivity.
$PREAMBLE
ETX

timeout=$(echo $POP3_SESSION_TIMEOUT | sed -e 's/[^0-9]//g')
test -z "$timeout" -o "$timeout" -eq 0 && \
    echo -n >"$POP3DENV/SESSION_TIMEOUT" || \
    cat >"$POP3DENV/SESSION_TIMEOUT" <<ETX
$timeout
#
# Times out connections after value seconds of inactivity.
$PREAMBLE
ETX

# authentication
cat >"$POP3DENV/CVM_SASL_PLAIN" <<ETX
cvm-${POP3_CVM_MODE:-command}:${POP3_CVM_LOCATION:-cvm-unix}
#
# CVM mode and module for POP3 authentication
$PREAMBLE
ETX

# TCP rules
tcprulesdir=$POP3DIR/rules
if test -n "$POP3_ALLOWFROMIP" || grep ^[0-9] "$tcprulesdir/include" &>/dev/null
then
    cat >$tcprulesdir/data <<ETX
$PREAMBLE
ETX
    ipmeprint | sort -u >>$tcprulesdir/data
    echo $POP3_ALLOWFROMIP | sed 's/[[:space:]]\{1,\}/\n/g' | sort -u \
	>>$tcprulesdir/data
    test -r "$tcprulesdir/include" && \
	grep ^[0-9] "$tcprulesdir/include" >>$tcprulesdir/data
    echo :deny >>$tcprulesdir/data
    ( cd $tcprulesdir; tcprules data.cdb data.tmp <data )
else
    rm -f $tcprulesdir/data $tcprulesdir/data.cdb
fi

# memory limits
limit=$(echo $POP3_LIMIT | sed -e 's/[^0-9]//g')
test -z "$limit" -o "$limit" -eq 0 && \
    echo -n >"$POP3DENV/LIMIT" || \
    cat >"$POP3DENV/LIMIT" <<ETX
$POP3_LIMIT
#
# memory limit in bytes for daemon
$PREAMBLE
ETX
