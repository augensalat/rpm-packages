#!/bin/sh
#
# check if we are started as root
# only one of UID and USER must be set correctly
#

if test "$UID" != 0 -a "$USER" != root; then
    echo >&2 "You must be root to start $0."
    exit 1
fi

#
# check for /etc/sysconfig/mailfront
#
if test ! -f /etc/sysconfig/mailfront ; then
    echo >&2 "No /etc/sysconfig/mailfront found."
    exit 1
fi 
. /etc/sysconfig/mailfront

test "$MAILFRONT_CREATE_CONFIG" = yes || exit 0

# this file contains generic mail setup information
if test -s /etc/sysconfig/mail ; then
    . /etc/sysconfig/mail
    test "$MAIL_CREATE_CONFIG" = yes || exit 0
fi

#
# set qmail config dirs
#
CIMAPDIR="/etc/courier-imap"
IMAPDDIR="${1:-/etc/mailfront-imapd}"
IMAPDENV="$IMAPDDIR/env"

#
# define preamble of config files
#
PREAMBLE="#
#
# Automatically generated on `env LANG=C date`
#
# PLEASE DO NOT EDIT THIS FILE
#
# Instead edit /etc/sysconfig/mailfront and restart the server.
#
#"

umask 022

test -z "$IMAP_ADDRESS" -o "$IMAP_ADDRESS" = 0 && \
    echo -n >"$IMAPDENV/ADDRESS" || \
    cat >"$IMAPDENV/ADDRESS" <<ETX
$IMAP_ADDRESS
#
# IP address the IMAP daemon should bind to on this host.
# Default is "0", which means to listen on all addresses of this host.
$PREAMBLE
ETX

test -z "$IMAP_PORT" -o "$IMAP_PORT" -eq 0 && \
    echo -n >"$IMAPDENV/PORT" || \
    cat >"$IMAPDENV/PORT" <<ETX
$IMAP_PORT
#
# Port number or name (from /etc/services) for the imap daemon.
$PREAMBLE
ETX

if test -z "$IMAP_LOCALNAME" ; then
    test -s /etc/HOSTNAME && \
	cp /etc/HOSTNAME "$IMAPDENV/LOCALNAME" || \
	(hostname -f | grep '\.' || echo 0) >"$IMAPDENV/LOCALNAME"
else
    echo $IMAP_LOCALNAME >"$IMAPDENV/LOCALNAME"
fi
cat >>"$IMAPDENV/LOCALNAME" <<ETX
#
# Set local hostname to keep tcpserver from looking it up in DNS.
# A common choice for localname is 0. To avoid loops, you must use this
# option for servers on TCP port 53.
$PREAMBLE
ETX

# Concurrency
concurrency=$(echo $IMAP_CONCURRENCY | sed -e 's/[^0-9]//g')
test -z "$concurrency" -o "$concurrency" -eq 0 && \
    echo -n >"$IMAPDENV/CONCURRENCY" || \
    cat >"$IMAPDENV/CONCURRENCY" <<ETX
$concurrency
#
# Maximum number of simultaneous imap daemon processes.
$PREAMBLE
ETX

# memory limits
limit=$(echo $IMAP_LIMIT | sed -e 's/[^0-9]//g')
test -z "$limit" -o "$limit" -eq 0 && \
    echo -n >"$IMAPDENV/LIMIT" || \
    cat >"$IMAPDENV/LIMIT" <<ETX
$IMAP_LIMIT
#
# memory limit in bytes for daemon
$PREAMBLE
ETX

# Timeouts
timeout=$(echo $IMAP_TIMEOUT | sed -e 's/[^0-9]//g')
test -z "$timeout" -o "$timeout" -eq 0 && \
    echo -n >"$IMAPDENV/AUTH_TIMEOUT" || \
    cat >"$IMAPDENV/AUTH_TIMEOUT" <<ETX
$timeout
#
# Times out connections after value seconds of inactivity.
$PREAMBLE
ETX

timeout=$(echo $IMAP_SESSION_TIMEOUT | sed -e 's/[^0-9]//g')
test -z "$timeout" -o "$timeout" -eq 0 && \
    echo -n >"$IMAPDENV/AUTH_SESSION_TIMEOUT" || \
    cat >"$IMAPDENV/AUTH_SESSION_TIMEOUT" <<ETX
$timeout
#
# Times out connections after value seconds of inactivity.
$PREAMBLE
ETX

# TCP rules
tcprulesdir=$IMAPDDIR/rules
if test -n "$IMAP_ALLOWFROMIP" || grep ^[0-9] "$tcprulesdir/include" &>/dev/null
then
    cat >$tcprulesdir/data <<ETX
$PREAMBLE
ETX
    ipmeprint | sort -u >>$tcprulesdir/data
    echo $IMAP_ALLOWFROMIP | sed 's/[[:space:]]\{1,\}/\n/g' | sort -u \
	>>$tcprulesdir/data
    test -r "$tcprulesdir/include" && \
	grep ^[0-9] "$tcprulesdir/include" >>$tcprulesdir/data
    echo :deny >>$tcprulesdir/data
    ( cd $tcprulesdir; tcprules data.cdb data.tmp <data )
else
    rm -f $tcprulesdir/data $tcprulesdir/data.cdb
fi

# authentication
cat >"$IMAPDENV/CVM_SASL_PLAIN" <<ETX
cvm-${IMAP_CVM_MODE:-command}:${IMAP_CVM_LOCATION:-cvm-unix}
#
# CVM mode and module for IMAP authentication
$PREAMBLE
ETX
cp "$IMAPDENV/CVM_SASL_PLAIN" "$IMAPDENV/CVM_SASL_LOGIN"

# CAPABILITY of imapd
cat >"$IMAPDENV/IMAP_CAPABILITY" <<ETX
${IMAP_CAPABILITY:-IMAP4rev1 CHILDREN NAMESPACE THREAD=ORDEREDSUBJECT THREAD=REFERENCES SORT QUOTA AUTH=PLAIN}
#
# IMAP_CAPABILITY specifies what most of the response should be to the
# CAPABILITY command.
$PREAMBLE
ETX

# 
test "$IMAP_KEYWORDS" = no && switch=0 || switch=1
cat >"$IMAPDENV/IMAP_KEYWORDS" <<ETX
$switch
#
# IMAP_KEYWORDS="1" enables custom IMAP keywords.
# Set this option to "0" to disable custom keywords.
$PREAMBLE
ETX

# 
test "$IMAP_ACL" = no && switch=0 || switch=1
cat >"$IMAPDENV/IMAP_ACL" <<ETX
$switch
#
# IMAP_KEYWORDS="1" enables custom IMAP keywords.
# Set this option to "0" to disable custom keywords.
$PREAMBLE
ETX

#
timeout=$(echo $IMAP_IDLE_TIMEOUT | sed -e 's/[^0-9]//g')
test -z "$timeout" -o "$timeout" -eq 0 && \
    echo -n >"$IMAPDENV/IMAP_IDLE_TIMEOUT" || \
    cat >"$IMAPDENV/IMAP_IDLE_TIMEOUT" <<ETX
$timeout
#
# If you want to try out the IDLE extension, this setting controls how often
# the server polls for changes to the folder, in IDLE mode (in seconds).
$PREAMBLE
ETX

# 
test "$IMAP_DISABLETHREADSORT" = yes && switch=1 || switch=0
cat >"$IMAPDENV/IMAP_DISABLETHREADSORT" <<ETX
$switch
#
# Set IMAP_DISABLETHREADSORT to disable the THREAD and SORT commands -
# server side sorting and threading.
#
# Those capabilities will still be advertised, but the server will reject
# them.  Set this option if you want to disable all the extra load from
# server-side threading and sorting.  Not advertising those capabilities
# will simply result in the clients reading the entire folder, and sorting
# it on the client side.  That will still put some load on the server.
# advertising these capabilities, but rejecting the commands, will stop this
# silliness.
$PREAMBLE
ETX

# 
test "$IMAP_CHECK_ALL_FOLDERS" = yes && switch=1 || switch=0
cat >"$IMAPDENV/IMAP_CHECK_ALL_FOLDERS" <<ETX
$switch
#
# Set IMAP_CHECK_ALL_FOLDERS to 1 if you want the server to check for new
# mail in every folder.  Not all IMAP clients use the IMAP's new mail
# indicator, but some do.  Normally new mail is checked only in INBOX,
# because it is a comparatively time consuming operation, and it would be
# a complete waste of time unless mail filters are used to deliver
# mail directly to folders.
#
# When IMAP clients are used which support new mail indication, and when
# mail filters are used to sort incoming mail into folders, setting
# IMAP_CHECK_ALL_FOLDERS to 1 will allow IMAP clients to announce new
# mail in folders.  Note that this will result in slightly more load on the
# server.
$PREAMBLE
ETX

# 
test "$IMAP_OBSOLETE_CLIENT" = yes && switch=1 || switch=0
cat >"$IMAPDENV/IMAP_OBSOLETE_CLIENT" <<ETX
$switch
#
# Set IMAP_OBSOLETE_CLIENT if your IMAP client expects \\NoInferiors to mean
# what \\HasNoChildren really means.
$PREAMBLE
ETX

# 
test "$IMAP_USELOCKS" = yes && switch=1 || switch=0
cat >"$IMAPDENV/IMAP_USELOCKS" <<ETX
$switch
#
# Set IMAP_USELOCKS to 1 if you experience weird problems when using IMAP
# clients that open multiple connections to the server.  I would hope that
# most IMAP clients are sane enough not to issue commands to multiple IMAP
# channels which conflict with each other.
$PREAMBLE
ETX

test "$IMAP_ENHANCEDIDLE" = yes && switch=1 || switch=0
cat >"$IMAPDENV/IMAP_ENHANCEDIDLE" <<ETX
$switch
#
# If Courier was compiled with the File Alteration Monitor, setting
# IMAP_ENHANCEDIDLE to 1 enables enhanced IDLE mode, where multiple
# clients may open the same folder concurrently, and receive updates to
# folder contents in realtime.  See the imapd(8) man page for additional
# information.
#
# IMPORTANT: IMAP_USELOCKS *MUST* also be set to 1, and IDLE must be included
# in the IMAP_CAPABILITY list.
$PREAMBLE
ETX

test -z "$IMAP_TRASHFOLDERNAME" && \
    echo -n >"$IMAPDENV/IMAP_TRASHFOLDERNAME" || \
    cat >"$IMAPDENV/IMAP_TRASHFOLDERNAME" <<ETX
$IMAP_TRASHFOLDERNAME
#
# The name of the magic trash Folder.  For MSOE compatibility,
# you can set IMAP_TRASHFOLDERNAME="Deleted Items".
#
# IMPORTANT:  If you change this, you must also change IMAP_EMPTYTRASH
$PREAMBLE
ETX

test -z "$IMAP_EMPTYTRASH" && \
    echo -n >"$IMAPDENV/IMAP_EMPTYTRASH" || \
    cat >"$IMAPDENV/IMAP_EMPTYTRASH" <<ETX
$IMAP_EMPTYTRASH
#
# This setting is optional, and causes messages from the given folder to
# be automatically deleted after the given number of days.
# IMAP_EMPTYTRASH is a comma-separated list of folder:days.  The default
# setting, above, purges 7 day old messages from the Trash folder.
# Another useful setting would be:
#
# IMAP_EMPTYTRASH=Trash:7,Sent:30
#
# This would also delete messages from the Sent folder (presumably copies
# of sent mail) after 30 days.  This is a global setting that is applied to
# every mail account, and is probably useful in a controlled, corporate
# environment.
#
# Important: the purging is controlled by CTIME, not MTIME (the file time
# as shown by ls).  It is perfectly ordinary to see stuff in Trash that's
# a year old.  That's the file modification time, MTIME, that's displayed.
# This is generally when the message was originally delivered to this
# mailbox.  Purging is controlled by a different timestamp, CTIME, which is
# changed when the file is moved to the Trash folder (and at other times too).
#
# You might want to disable this setting in certain situations - it results
# in a stat() of every file in each folder, at login and logout.
$PREAMBLE
ETX

test "$IMAP_MOVE_EXPUNGE_TO_TRASH" = yes && switch=1 || switch=0
cat >"$IMAPDENV/IMAP_MOVE_EXPUNGE_TO_TRASH" <<ETX
$switch
#
# Set IMAP_MOVE_EXPUNGE_TO_TRASH to move expunged messages to Trash.  This
# effectively allows an undo of message deletion by fishing the deleted
# mail from trash.  Trash can be manually expunged as usually, and mail
# will get automatically expunged from Trash according to IMAP_EMPTYTRASH.
#
# NOTE: shared folders are still expunged as usual.  Shared folders are
# not affected.
$PREAMBLE
ETX

if test "$IMAP_OUTBOX_ENHANCEMENT" = yes ; then
    cat >"$IMAPDENV/SENDMAIL" <<ETX
/usr/sbin/sendmail
#
# If OUTBOX is defined, mail can be sent via the IMAP connection by copying
# a message to the INBOX.Outbox folder.  For all practical matters,
# INBOX.Outbox looks and behaves just like any other IMAP folder.  If this
# folder doesn't exist it must be created by the IMAP mail client, just
# like any other IMAP folder.  The kicker: any message copied or moved to
# this folder is will be E-mailed by the Courier-IMAP server, by running
# the SENDMAIL program.  Therefore, messages copied or moved to this
# folder must be well-formed RFC-2822 messages, with the recipient list
# specified in the To:, Cc:, and Bcc: headers.  Courier-IMAP relies on
# SENDMAIL to read the recipient list from these headers (and delete the Bcc:
# header) by running the command "$SENDMAIL -oi -t -f $SENDER", with the
# message piped on standard input.  $SENDER will be the return address
# of the message, which is set by the authentication module.
$PREAMBLE
ETX

    cat >"$IMAPDENV/OUTBOX" <<ETX
${IMAP_OUTBOX_NAME:-.Outbox}
#
# Name the special folder, named INBOX.Outbox
$PREAMBLE
ETX

    test -z "$IMAP_HEADERFROM" && \
	echo -n >"$IMAPDENV/HEADERFROM" || \
	cat >"$IMAPDENV/HEADERFROM" <<ETX
$IMAP_HEADERFROM
#
# For administrative and oversight purposes, the return address, $SENDER
# will also be saved in the X-IMAP-Sender mail header.  This header gets
# added to the sent E-mail (but it doesn't get saved in the copy of the
# message that's saved in the folder)
$PREAMBLE
ETX

    test "$IMAP_OUTBOX_MULTIPLE_SEND" = yes && switch=1 || switch=0
    cat >"$IMAPDENV/OUTBOX_MULTIPLE_SEND" <<ETX
$switch
#
# If set allow a COPY of more than one message to the Outbox, at a time.
$PREAMBLE
ETX

else
    echo -n >"$IMAPDENV/OUTBOX"
    echo -n >"$IMAPDENV/HEADERFROM"
    echo -n >"$IMAPDENV/OUTBOX_MULTIPLE_SEND"
fi

function ssl_config() {
    if test ! -s "$CIMAPDIR/imapd.pem" -a -x /usr/bin/openssl -a -s "$CIMAPDIR/imapd.cnf"
    then
	oldmask=$(umask)
	umask 077

	dd if=/dev/urandom of=$CIMAPDIR/imapd.rand count=1 2>/dev/null
	/usr/bin/openssl req -new -x509 -days 1461 -nodes \
	    -config $CIMAPDIR/imapd.cnf -out $CIMAPDIR/imapd.pem -keyout $CIMAPDIR/imapd.pem && \
	/usr/bin/openssl gendh -rand $CIMAPDIR/imapd.rand 512 >>$CIMAPDIR/imapd.pem && \
	/usr/bin/openssl x509 -subject -dates -fingerprint -noout -in $CIMAPDIR/imapd.pem && \
	rm -f $CIMAPDIR/imapd.rand || \
	rm -f $CIMAPDIR/{imapd.pem,imapd.rand,imapd.key,imapd.cert}

	umask $oldmask
    fi

    test -s "$CIMAPDIR/imapd.pem"
}

if test "$IMAP_STARTTLS" = yes && ssl_config ; then
    cat >"$IMAPDENV/IMAP_STARTTLS" <<ETX
yes
#
# Whether or not to implement IMAP STARTTLS extension.
$PREAMBLE
ETX

    test "$IMAP_TLS_REQUIRED" = yes && switch=1 || switch=0
    cat >"$IMAPDENV/IMAP_TLS_REQUIRED" <<ETX
$switch
#
# Set IMAP_TLS_REQUIRED to "yes" if you REQUIRE STARTTLS for everyone.
# (this option advertises the LOGINDISABLED IMAP capability, until STARTTLS
# is issued).
$PREAMBLE
ETX

    cat >"$IMAPDENV/TLS_PROTOCOL" <<ETX
${IMAP_TLS_PROTOCOL:-TLS1}
#
# Set the protocol version. The possible values are
# SSL2 - SSLv2
# SSL3 - SSLv3
# SSL23 - either SSLv2 or SSLv3
# TLS1 - TLS1
$PREAMBLE
ETX

    test -z "$IMAP_TLS_CIPHER_LIST" && \
	echo -n >"$IMAPDENV/TLS_CIPHER_LIST" || \
	cat >"$IMAPDENV/TLS_CIPHER_LIST" <<ETX
$IMAP_TLS_CIPHER_LIST
#
# TLS_CIPHER_LIST optionally sets the list of ciphers to be used by the
# OpenSSL library.  In most situations you can leave TLS_CIPHER_LIST
# undefined
#
# IMAP_TLS_CIPHER_LIST="ALL:!ADH:RC4+RSA:+SSLv2:@STRENGTH"
$PREAMBLE
ETX

    test -z "$IMAP_TLS_DHCERTFILE" && \
	echo -n >"$IMAPDENV/TLS_DHCERTFILE" || \
	cat >"$IMAPDENV/TLS_DHCERTFILE" <<ETX
$IMAP_TLS_DHCERTFILE
#
# PEM file that stores our Diffie-Hellman cipher pair. When OpenSSL is
# compiled to use Diffie-Hellman ciphers instead of RSA you must
# generate a DH pair that will be used. In most situations the DH pair
# is to be treated as confidential, and filename must not be
# world-readable.
$PREAMBLE
ETX


else
    echo -n >"$IMAPDENV/IMAP_STARTTLS"
    echo -n >"$IMAPDENV/IMAP_TLS_REQUIRED"
    echo -n >"$IMAPDENV/TLS_PROTOCOL"
    echo -n >"$IMAPDENV/TLS_DHCERTFILE"
fi


