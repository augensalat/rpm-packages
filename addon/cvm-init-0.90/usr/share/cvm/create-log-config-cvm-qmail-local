#!/bin/sh
#
# check if we are started as root
# only one of UID and USER must be set correctly
#
if test "$UID" != 0 -a "$USER" != root; then
    echo >&2 "You must be root to start $0."
    exit 1
fi

#
# check for /etc/sysconfig/cvm
#
if test ! -f /etc/sysconfig/cvm ; then
    echo >&2 "No /etc/sysconfig/cvm found."
    exit 1
fi 
. /etc/sysconfig/cvm

test "$CVM_CREATE_CONFIG" = yes || exit 0

#
# set cvm-qmail-local config dir
#
CVMDIR="${1:-/etc/cvm-qmail-local}"
CVMENV="${CVMDIR}/env"

#
# define preamble of config files
#
PREAMBLE="#
#
# Automatically generated on $(env LANG=C date)
#
# PLEASE DO NOT EDIT THIS FILE
#
# Instead edit /etc/sysconfig/cvm and restart the server.
#
#"

umask 022

# multilog
size=$(echo $CVM_QMAIL_LOCAL_LOGSIZE | sed -e 's/[^0-9]//g')
test -z "$size" -o "$size" -lt 4096 && \
    echo -n >"$CVMENV/LOGSIZE" || \
    cat >"$CVMENV/LOGSIZE" <<ETX
$size
#
# Sets the maximum file size for subsequent dir actions. multilog will
# decide that current is big enough if current has size bytes. (multilog
# will also decide that current is big enough if it sees a newline within
# 2000 bytes of the maximum file size; it tries to finish log files at line
# boundaries.) size must be between 4096 and 16777215.
$PREAMBLE
ETX

num=$(echo $CVM_QMAIL_LOCAL_LOGNUM | sed -e 's/[^0-9]//g')
test -z "$num" -o "$num" -lt 2 && \
    echo -n >"$CVMENV/LOGNUM" || \
    cat >"$CVMENV/LOGNUM" <<ETX
$num
#
# Sets the number of log files for subsequent dir actions. After renaming
# current, if multilog sees num or more old log files, it removes the old
# log file with the smallest timestamp. num must be at least 2.
$PREAMBLE
ETX
