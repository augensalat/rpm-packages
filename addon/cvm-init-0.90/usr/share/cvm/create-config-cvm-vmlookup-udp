#!/bin/sh
#
# check if we are started as root
# only one of UID and USER must be set correctly
#
if test "$UID" != 0 -a "$USER" != root; then
    echo >&2 "You must be root to start $0."
    exit 1
fi

#
# check for /etc/sysconfig/cvm
#
if test ! -f /etc/sysconfig/cvm ; then
    echo >&2 "No /etc/sysconfig/cvm found."
    exit 1
fi 
. /etc/sysconfig/cvm

test "$CVM_CREATE_CONFIG" = yes || exit 0

#
# set cvm-qmail-udp config dirs
#
CVMDIR="${1:-/etc/cvm-vmlookup-udp}"
CVMENV="${CVMDIR}/env"

#
# define preamble of config files
#
PREAMBLE="#
#
# Automatically generated on $(env LANG=C date)
#
# PLEASE DO NOT EDIT THIS FILE
#
# Instead edit /etc/sysconfig/cvm and restart the server.
#
#"

umask 022

test -z "$CVM_VMLOOKUP_UDP_ADDRESS" -o "$CVM_VMLOOKUP_UDP_ADDRESS" = 0 && \
    echo -n >"$CVMENV/ADDRESS" || \
    cat >"$CVMENV/ADDRESS" <<ETX
$CVM_VMLOOKUP_UDP_ADDRESS
#
# Interface IP address the CVM daemon should bind to on this host.
# Default is "", which means to listen on all addresses of this host.
$PREAMBLE
ETX
    
test -z "$CVM_VMLOOKUP_UDP_PORT" -o "$CVM_VMLOOKUP_UDP_PORT" = "0" && \
    echo -n >"$CVMENV/PORT" || \
    cat >"$CVMENV/PORT" <<ETX
$CVM_VMLOOKUP_UDP_PORT
#
# Port number or name (from /etc/services) for cvm-qmail-udp.
$PREAMBLE
ETX

limit=$(echo $CVM_VMLOOKUP_UDP_LIMIT | sed -e 's/[^0-9]//g')
test -z "$limit" -o "$limit" -eq 0 && \
    echo -n >"$CVMENV/LIMIT" || \
    cat >"$CVMENV/LIMIT" <<ETX
$limit
#
# Limit data and stack segment, locked physical pages and total of all
# segments per process to n bytes each.
$PREAMBLE
ETX

cat >"$CVMENV/CVM_LOOKUP_SECRET" <<ETX
$CVM_VMLOOKUP_UDP_SECRET
#
# If $CVM_LOOKUP_SECRET is set, the module operates in "lookup mode".
# If set to an non-empty value, data is encrypted before piped to the
# other end of the connection. Usefull for UDP mode.
$PREAMBLE
ETX
