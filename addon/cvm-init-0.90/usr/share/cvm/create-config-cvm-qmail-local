#!/bin/sh
#
# check if we are started as root
# only one of UID and USER must be set correctly
#
if test "$UID" != 0 -a "$USER" != root; then
    echo >&2 "You must be root to start $0."
    exit 1
fi

#
# check for /etc/sysconfig/cvm
#
if test ! -f /etc/sysconfig/cvm ; then
    echo >&2 "No /etc/sysconfig/cvm found."
    exit 1
fi 
. /etc/sysconfig/cvm

test "$CVM_CREATE_CONFIG" = yes || exit 0

#
# set cvm-qmail-local config dir
#
CVMDIR="${1:-/etc/cvm-qmail-local}"
CVMENV="${CVMDIR}/env"

#
# define preamble of config files
#
PREAMBLE="#
#
# Automatically generated on $(env LANG=C date)
#
# PLEASE DO NOT EDIT THIS FILE
#
# Instead edit /etc/sysconfig/cvm and restart the server.
#
#"

umask 022

test -z "$CVM_QMAIL_LOCAL_SOCKET" && \
    echo -n >"$CVMENV/SOCKET" || \
    cat >"$CVMENV/SOCKET" <<ETX
$CVM_QMAIL_LOCAL_SOCKET
#
# Filename of unix domain socket for cvm-qmail-local.
$PREAMBLE
ETX

limit=$(echo $CVM_QMAIL_LOCAL_LIMIT | sed -e 's/[^0-9]//g')
test -z "$limit" -o "$limit" -eq 0 && \
    echo -n >"$CVMENV/LIMIT" || \
    cat >"$CVMENV/LIMIT" <<ETX
$limit
#
# Limit data and stack segment, locked physical pages and total of all
# segments per process to n bytes each.
$PREAMBLE
ETX

cat >"$CVMENV/CVM_LOOKUP_SECRET" <<ETX
$CVM_QMAIL_LOCAL_SECRET
#
# Use a secret if lookup'ed data must be encrypted before piped through a
# socket. This environment variable must exist, even if it is empty!
$PREAMBLE
ETX
